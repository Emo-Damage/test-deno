{"version":3,"file":"main.js","mappings":"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","sources":["webpack:///./src/app/utils.ts","webpack:///../../libs/vless-js/src/index.ts","webpack:///../../libs/vless-js/src/lib/vless-js.ts","webpack:///external commonjs \"pretty-cache-header\"","webpack:///external commonjs \"tslib\"","webpack:///external commonjs \"uuid\"","webpack:///external commonjs \"ws\"","webpack:///external node-commonjs \"http\"","webpack:///external node-commonjs \"node:dgram\"","webpack:///external node-commonjs \"node:dns\"","webpack:///external node-commonjs \"node:fs\"","webpack:///external node-commonjs \"node:net\"","webpack:///external node-commonjs \"node:path\"","webpack:///external node-commonjs \"node:stream/web\"","webpack:///external node-commonjs \"stream\"","webpack:///external node-commonjs \"url\"","webpack:///webpack/bootstrap","webpack:///./src/main.ts"],"sourcesContent":["import { createReadStream, existsSync } from 'node:fs';\nimport { IncomingMessage, ServerResponse } from 'node:http';\nimport { resolve, join, extname } from 'node:path';\nimport { cacheHeader } from 'pretty-cache-header';\n\nconst mimeLookup = {\n  '.js': 'application/javascript,charset=UTF-8',\n  '.html': 'text/html,charset=UTF-8',\n  '.css': 'text/css; charset=UTF-8',\n};\nconst staticPath = 'dist/apps/cf-page/';\nconst file401 = 'dist/apps/node-vless/assets/401.html';\nlet filepath = null;\nexport function serverStaticFile(req: IncomingMessage, resp: ServerResponse) {\n  const url = new URL(req.url, `http://${req.headers['host']}`);\n  let fileurl = url.pathname;\n  fileurl = join(staticPath, fileurl);\n  console.log('....', fileurl);\n  filepath = resolve(fileurl);\n  console.log(filepath);\n\n  if (existsSync(filepath)) {\n    let fileExt = extname(filepath);\n    console.log('fileExt', fileExt);\n    let mimeType = mimeLookup[fileExt];\n\n    resp.writeHead(200, {\n      'Content-Type': mimeType,\n      'Cache-Control': cacheHeader({\n        public: true,\n        maxAge: '1year',\n        staleWhileRevalidate: '1year',\n      }),\n    });\n    return createReadStream(filepath).pipe(resp);\n  } else {\n    resp.writeHead(404);\n    resp.write('not found');\n    resp.end();\n    return resp;\n  }\n}\n\nexport function index401(req: IncomingMessage, resp: ServerResponse) {\n  const file401Path = resolve(file401);\n  if (existsSync(file401Path)) {\n    createReadStream(file401Path).pipe(resp);\n  } else {\n    resp.writeHead(401);\n    resp.write('UUID env not set');\n    resp.end();\n  }\n}\n\nexport function serverIndexPage(\n  req: IncomingMessage,\n  resp: ServerResponse,\n  uuid\n) {\n  // if()\n}\n","export {\n  delay,\n  makeReadableWebSocketStream,\n  closeWebSocket,\n  processVlessHeader,\n} from './lib/vless-js';\n","import { stringify } from 'uuid';\nexport function vlessJs(): string {\n  return 'vless-js';\n}\n\nexport function delay(ms: number) {\n  return new Promise((resolve, rej) => {\n    setTimeout(resolve, ms);\n  });\n}\n\nexport function makeReadableWebSocketStream(\n  ws: WebSocket | any,\n  earlyDataHeader: string,\n  log: Function\n) {\n  let readableStreamCancel = false;\n  return new ReadableStream<ArrayBuffer>({\n    start(controller) {\n      ws.addEventListener('message', async (e: { data: ArrayBuffer }) => {\n        // is stream is cancel, skip controller.enqueue\n        if (readableStreamCancel) {\n          return;\n        }\n        const vlessBuffer: ArrayBuffer = e.data;\n        // console.log('MESSAGE', vlessBuffer);\n        // console.log(`message is ${vlessBuffer.byteLength}`);\n        // this is not backpressure, but backpressure is depends on underying websocket can pasue\n        // https://streams.spec.whatwg.org/#example-rs-push-backpressure\n        controller.enqueue(vlessBuffer);\n      });\n      ws.addEventListener('error', (e: any) => {\n        log('socket has error');\n        readableStreamCancel = true;\n        controller.error(e);\n      });\n      ws.addEventListener('close', () => {\n        try {\n          log('webSocket is close');\n          // is stream is cancel, skip controller.close\n          if (readableStreamCancel) {\n            return;\n          }\n          controller.close();\n        } catch (error) {\n          log(`websocketStream can't close DUE to `, error);\n        }\n      });\n      // header ws 0rtt\n      const { earlyData, error } = base64ToArrayBuffer(earlyDataHeader);\n      if (error) {\n        log(`earlyDataHeader has invaild base64`);\n        closeWebSocket(ws);\n        return;\n      }\n      if (earlyData) {\n        controller.enqueue(earlyData);\n      }\n    },\n    pull(controller) {\n      // if ws can stop read if stream is full, we can implement backpressure\n      // https://streams.spec.whatwg.org/#example-rs-push-backpressure\n    },\n    cancel(reason) {\n      // TODO: log can be remove, if writestream has error, write stream will has log\n      log(`websocketStream is cancel DUE to `, reason);\n      if (readableStreamCancel) {\n        return;\n      }\n      readableStreamCancel = true;\n      closeWebSocket(ws);\n    },\n  });\n}\n\nfunction base64ToArrayBuffer(base64Str: string) {\n  if (!base64Str) {\n    return { error: null };\n  }\n  try {\n    // go use modified Base64 for URL rfc4648 which js atob not support\n    base64Str = base64Str.replace(/-/g, '+').replace(/_/g, '/');\n    const decode = atob(base64Str);\n    const arryBuffer = Uint8Array.from(decode, (c) => c.charCodeAt(0));\n    return { earlyData: arryBuffer.buffer, error: null };\n  } catch (error) {\n    return { error };\n  }\n}\n\nexport function closeWebSocket(socket: WebSocket | any) {\n  if (socket.readyState === socket.OPEN) {\n    socket.close();\n  }\n}\n\n//https://github.com/v2ray/v2ray-core/issues/2636\n// 1 字节\t  16 字节       1 字节\t       M 字节\t              1 字节            2 字节      1 字节\t      S 字节\t      X 字节\n// 协议版本\t  等价 UUID\t  附加信息长度 M\t(附加信息 ProtoBuf)  指令(udp/tcp)\t    端口\t      地址类型      地址\t        请求数据\n// 00                   00                                  01                 01bb(443)   02(ip/host)\n// 1 字节\t              1 字节\t      N 字节\t         Y 字节\n// 协议版本，与请求的一致\t附加信息长度 N\t附加信息 ProtoBuf\t响应数据\nexport function processVlessHeader(\n  vlessBuffer: ArrayBuffer,\n  userID: string\n  // uuidLib: any,\n  // lodash: any\n) {\n  if (vlessBuffer.byteLength < 24) {\n    // console.log('invalid data');\n    // controller.error('invalid data');\n    return {\n      hasError: true,\n      message: 'invalid data',\n    };\n  }\n  const version = new Uint8Array(vlessBuffer.slice(0, 1));\n  let isValidUser = false;\n  let isUDP = false;\n  if (stringify(new Uint8Array(vlessBuffer.slice(1, 17))) === userID) {\n    isValidUser = true;\n  }\n  if (!isValidUser) {\n    // console.log('in valid user');\n    // controller.error('in valid user');\n    return {\n      hasError: true,\n      message: 'invalid user',\n    };\n  }\n\n  const optLength = new Uint8Array(vlessBuffer.slice(17, 18))[0];\n  //skip opt for now\n\n  const command = new Uint8Array(\n    vlessBuffer.slice(18 + optLength, 18 + optLength + 1)\n  )[0];\n\n  // 0x01 TCP\n  // 0x02 UDP\n  // 0x03 MUX\n  if (command === 1) {\n  } else if (command === 2) {\n    isUDP = true;\n  } else {\n    return {\n      hasError: true,\n      message: `command ${command} is not support, command 01-tcp,02-udp,03-mux`,\n    };\n  }\n  const portIndex = 18 + optLength + 1;\n  const portBuffer = vlessBuffer.slice(portIndex, portIndex + 2);\n  // port is big-Endian in raw data etc 80 == 0x005d\n  const portRemote = new DataView(portBuffer).getInt16(0);\n\n  let addressIndex = portIndex + 2;\n  const addressBuffer = new Uint8Array(\n    vlessBuffer.slice(addressIndex, addressIndex + 1)\n  );\n\n  // 1--> ipv4  addressLength =4\n  // 2--> domain name addressLength=addressBuffer[1]\n  // 3--> ipv6  addressLength =16\n  const addressType = addressBuffer[0];\n  let addressLength = 0;\n  let addressValueIndex = addressIndex + 1;\n  let addressValue = '';\n  switch (addressType) {\n    case 1:\n      addressLength = 4;\n      addressValue = new Uint8Array(\n        vlessBuffer.slice(addressValueIndex, addressValueIndex + addressLength)\n      ).join('.');\n      break;\n    case 2:\n      addressLength = new Uint8Array(\n        vlessBuffer.slice(addressValueIndex, addressValueIndex + 1)\n      )[0];\n      addressValueIndex += 1;\n      addressValue = new TextDecoder().decode(\n        vlessBuffer.slice(addressValueIndex, addressValueIndex + addressLength)\n      );\n      break;\n    case 3:\n      addressLength = 16;\n      const dataView = new DataView(\n        vlessBuffer.slice(addressValueIndex, addressValueIndex + addressLength)\n      );\n      // 2001:0db8:85a3:0000:0000:8a2e:0370:7334\n      const ipv6 = [];\n      for (let i = 0; i < 8; i++) {\n        ipv6.push(dataView.getUint16(i * 2).toString(16));\n      }\n      addressValue = ipv6.join(':');\n      // console.log('---------', addressValue)\n      // seems no need add [] for ipv6\n      // if (addressValue) {\n      //   addressValue = `[${addressValue}]`;\n      // }\n      break;\n    default:\n      console.log(`invild  addressType is ${addressType}`);\n  }\n  if (!addressValue) {\n    // console.log(`[${address}:${port}] addressValue is empty`);\n    // controller.error(`[${address}:${portWithRandomLog}] addressValue is empty`);\n    return {\n      hasError: true,\n      message: `addressValue is empty, addressType is ${addressType}`,\n    };\n  }\n\n  return {\n    hasError: false,\n    addressRemote: addressValue,\n    portRemote,\n    rawDataIndex: addressValueIndex + addressLength,\n    vlessVersion: version,\n    isUDP,\n  };\n}\n","module.exports = require(\"pretty-cache-header\");","module.exports = require(\"tslib\");","module.exports = require(\"uuid\");","module.exports = require(\"ws\");","module.exports = require(\"http\");","module.exports = require(\"node:dgram\");","module.exports = require(\"node:dns\");","module.exports = require(\"node:fs\");","module.exports = require(\"node:net\");","module.exports = require(\"node:path\");","module.exports = require(\"node:stream/web\");","module.exports = require(\"stream\");","module.exports = require(\"url\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import { createServer } from 'http';\nimport { parse } from 'url';\nimport { WebSocketServer, WebSocket } from 'ws';\nimport { index401, serverStaticFile } from './app/utils';\nimport { validate } from 'uuid';\nimport { createReadStream } from 'node:fs';\nimport { setDefaultResultOrder } from 'node:dns';\nimport { createSocket, Socket as UDPSocket } from 'node:dgram';\n\nimport {\n  makeReadableWebSocketStream,\n  processVlessHeader,\n  delay,\n  closeWebSocket,\n} from 'vless-js';\nimport { connect, Socket } from 'node:net';\nimport { Duplex, Readable } from 'stream';\nimport {\n  TransformStream,\n  ReadableStream,\n  WritableStream,\n} from 'node:stream/web';\nconst port = process.env.PORT;\nconst userID = process.env.UUID || '';\n//'ipv4first' or 'verbatim'\nconst dnOder = process.env.DNSORDER || 'verbatim';\nif (dnOder === 'ipv4first') {\n  setDefaultResultOrder(dnOder);\n}\n\nlet isVaildUser = validate(userID);\nif (!isVaildUser) {\n  console.log('not set valid UUID');\n}\n\nconst server = createServer((req, resp) => {\n  if (!isVaildUser) {\n    return index401(req, resp);\n  }\n  const url = new URL(req.url, `http://${req.headers['host']}`);\n  // health check\n  if (req.method === 'GET' && url.pathname.startsWith('/health')) {\n    resp.writeHead(200);\n    resp.write('health 200');\n    resp.end();\n    return;\n  }\n\n  // index page\n  if (url.pathname.includes(userID)) {\n    const index = 'dist/apps/cf-page/index.html';\n    resp.writeHead(200, {\n      'Content-Type': 'text/html,charset=UTF-8',\n    });\n    return createReadStream(index).pipe(resp);\n  }\n  if (req.method === 'GET' && url.pathname.startsWith('/assets')) {\n    return serverStaticFile(req, resp);\n  }\n\n  const basicAuth = req.headers.authorization || '';\n  const authStringBase64 = basicAuth.split(' ')?.[1] || '';\n  const authString = Buffer.from(authStringBase64, 'base64').toString('ascii');\n  if (authString && authString.includes(userID)) {\n    resp.writeHead(302, {\n      'content-type': 'text/html; charset=utf-8',\n      Location: `./${userID}`,\n    });\n    resp.end();\n  } else {\n    resp.writeHead(401, {\n      'content-type': 'text/html; charset=utf-8',\n      'WWW-Authenticate': 'Basic',\n    });\n    resp.end();\n  }\n});\nconst vlessWServer = new WebSocketServer({ noServer: true });\n\nvlessWServer.on('connection', async function connection(ws, request) {\n  let address = '';\n  let portWithRandomLog = '';\n  try {\n    const log = (info: string, event?: any) => {\n      console.log(`[${address}:${portWithRandomLog}] ${info}`, event || '');\n    };\n    let remoteConnection: Duplex = null;\n    let udpClientStream: TransformStream = null;\n    let remoteConnectionReadyResolve: Function;\n    const earlyDataHeader = request.headers['sec-websocket-protocol'];\n    const readableWebSocketStream = makeReadableWebSocketStream(\n      ws,\n      earlyDataHeader,\n      log\n    );\n    let vlessResponseHeader: Uint8Array | null = null;\n\n    // ws  --> remote\n    readableWebSocketStream\n      .pipeTo(\n        new WritableStream({\n          async write(chunk: Buffer, controller) {\n            if (!Buffer.isBuffer(chunk)) {\n              chunk = Buffer.from(chunk);\n            }\n            if (udpClientStream) {\n              const writer = udpClientStream.writable.getWriter();\n              // nodejs buffer to ArrayBuffer issue\n              // https://nodejs.org/dist/latest-v18.x/docs/api/buffer.html#bufbuffer\n              await writer.write(\n                chunk.buffer.slice(\n                  chunk.byteOffset,\n                  chunk.byteOffset + chunk.length\n                )\n              );\n              writer.releaseLock();\n              return;\n            }\n            if (remoteConnection) {\n              await socketAsyncWrite(remoteConnection, chunk);\n              // remoteConnection.write(chunk);\n              return;\n            }\n            const vlessBuffer = chunk.buffer.slice(\n              chunk.byteOffset,\n              chunk.byteOffset + chunk.length\n            );\n            const {\n              hasError,\n              message,\n              portRemote,\n              addressRemote,\n              rawDataIndex,\n              vlessVersion,\n              isUDP,\n            } = processVlessHeader(vlessBuffer, userID);\n            address = addressRemote || '';\n            portWithRandomLog = `${portRemote}--${Math.random()} ${\n              isUDP ? 'udp ' : 'tcp '\n            } `;\n            if (hasError) {\n              controller.error(`[${address}:${portWithRandomLog}] ${message} `);\n            }\n            // const addressType = requestAddr >> 42\n            // const addressLength = requestAddr & 0x0f;\n            console.log(`[${address}:${portWithRandomLog}] connecting`);\n            vlessResponseHeader = new Uint8Array([vlessVersion![0], 0]);\n            const rawClientData = vlessBuffer.slice(rawDataIndex!);\n            if (isUDP) {\n              udpClientStream = makeUDPSocketStream(portRemote, address);\n              const writer = udpClientStream.writable.getWriter();\n              writer.write(rawClientData).catch((error) => console.log);\n              writer.releaseLock();\n              remoteConnectionReadyResolve(udpClientStream);\n            } else {\n              remoteConnection = await connect2Remote(portRemote, address, log);\n              remoteConnection.write(new Uint8Array(rawClientData));\n              remoteConnectionReadyResolve(remoteConnection);\n            }\n          },\n          close() {\n            // if (udpClientStream ) {\n            //   udpClientStream.writable.close();\n            // }\n            console.log(\n              `[${address}:${portWithRandomLog}] readableWebSocketStream is close`\n            );\n          },\n          abort(reason) {\n            // TODO: log can be remove, abort will catch by catch block\n            console.log(\n              `[${address}:${portWithRandomLog}] readableWebSocketStream is abort`,\n              JSON.stringify(reason)\n            );\n          },\n        })\n      )\n      .catch((error) => {\n        console.error(\n          `[${address}:${portWithRandomLog}] readableWebSocketStream pipeto has exception`,\n          error.stack || error\n        );\n        // error is cancel readable stream anyway, no need close websocket in here\n        // closeWebSocket(webSocket);\n        // close remote conn\n        // remoteConnection?.close();\n      });\n\n    await new Promise((resolve) => (remoteConnectionReadyResolve = resolve));\n    // remote --> ws\n    let responseStream = udpClientStream?.readable;\n    if (remoteConnection) {\n      responseStream = Readable.toWeb(remoteConnection);\n    }\n\n    // if readable not pipe can't wait fro writeable write method\n    await responseStream.pipeTo(\n      new WritableStream({\n        start() {\n          if (ws.readyState === ws.OPEN) {\n            ws.send(vlessResponseHeader!);\n          }\n        },\n        async write(chunk: Uint8Array, controller) {\n          // console.log('ws write', chunk);\n          if (ws.readyState === ws.OPEN) {\n            await wsAsyncWrite(ws, chunk);\n          }\n        },\n        close() {\n          console.log(\n            `[${address}:${portWithRandomLog}] remoteConnection!.readable is close`\n          );\n        },\n        abort(reason) {\n          closeWebSocket(ws);\n          console.error(\n            `[${address}:${portWithRandomLog}] remoteConnection!.readable abort`,\n            reason\n          );\n        },\n      })\n    );\n  } catch (error) {\n    console.error(\n      `[${address}:${portWithRandomLog}] processWebSocket has exception `,\n      error.stack || error\n    );\n    closeWebSocket(ws);\n  }\n});\n\nserver.on('upgrade', function upgrade(request, socket, head) {\n  const { pathname } = parse(request.url);\n\n  vlessWServer.handleUpgrade(request, socket, head, function done(ws) {\n    vlessWServer.emit('connection', ws, request);\n  });\n});\n\nserver.listen(\n  {\n    port: port,\n    host: '0.0.0.0',\n  },\n  () => {\n    console.log(`server listen in http://127.0.0.1:${port}`);\n  }\n);\n\nasync function connect2Remote(port, host, log: Function): Promise<Socket> {\n  return new Promise((resole, reject) => {\n    const remoteSocket = connect(\n      {\n        port: port,\n        host: host,\n        // https://github.com/nodejs/node/pull/46587\n        // autoSelectFamily: true,\n      },\n      () => {\n        log(`connected`);\n        resole(remoteSocket);\n      }\n    );\n    remoteSocket.addListener('error', () => {\n      reject('remoteSocket has error');\n    });\n  });\n}\n\nasync function socketAsyncWrite(ws: Duplex, chunk: Buffer) {\n  return new Promise((resolve, reject) => {\n    ws.write(chunk, (error) => {\n      if (error) {\n        reject(error);\n      } else {\n        resolve('');\n      }\n    });\n  });\n}\n\nasync function wsAsyncWrite(ws: WebSocket, chunk: Uint8Array) {\n  // 20m not transmitted to the network\n  while (ws.bufferedAmount > 1024 * 20) {\n    await delay(10);\n  }\n  return new Promise((resolve, reject) => {\n    ws.send(chunk, (error) => {\n      if (error) {\n        reject(error);\n      } else {\n        resolve('');\n      }\n    });\n  });\n}\n\nfunction makeUDPSocketStream(portRemote, address) {\n  const udpClient = createSocket('udp4');\n  const transformStream = new TransformStream({\n    start(controller) {\n      /* … */\n      udpClient.on('message', (message, info) => {\n        controller.enqueue(\n          Buffer.concat([new Uint8Array([0, info.size]), message])\n        );\n      });\n      udpClient.on('error', (error) => {\n        console.log('udpClient error event', error);\n        controller.error(error);\n      });\n    },\n\n    async transform(chunk: ArrayBuffer, controller) {\n      //seems v2ray will use same web socket for dns query..\n      //And v2ray will combine A record and AAAA record into one ws message and use 2 btye for dns query length\n      for (let index = 0; index < chunk.byteLength; ) {\n        const lengthBuffer = chunk.slice(index, index + 2);\n        const udpPakcetLength = new DataView(lengthBuffer).getInt16(0);\n        const udpData = new Uint8Array(\n          chunk.slice(index + 2, index + 2 + udpPakcetLength)\n        );\n        index = index + 2 + udpPakcetLength;\n        await new Promise((resolve, reject) => {\n          udpClient.send(udpData, portRemote, address, (err) => {\n            if (err) {\n              console.log('udps send error', err);\n              controller.error(`Failed to send UDP packet !! ${err}`);\n              safeCloseUDP(udpClient);\n            }\n            resolve(true);\n          });\n        });\n        index = index;\n      }\n\n      // console.log('dns chunk', chunk);\n      // console.log(portRemote, address);\n      // port is big-Endian in raw data etc 80 == 0x005d\n    },\n\n    flush(controller) {\n      safeCloseUDP(udpClient);\n      controller.terminate();\n    },\n  });\n  return transformStream;\n}\n\nfunction safeCloseUDP(client: UDPSocket) {\n  try {\n    client.close();\n  } catch (error) {\n    console.log('error close udp', error);\n  }\n}\n"],"names":[],"sourceRoot":""}